<!doctype html><html lang=en><head><title>xeus-clickhouse: Jupyter 的 ClickHouse 内核 :: Wang Fenjin</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="支持直接在 jupyter 中用 clickhouse sql 查询数据"><meta name=keywords content="clickhouse,jupyter,jupyter-kernal"><meta name=robots content="noodp"><link rel=canonical href=https://www.wangfenjin.com/posts/jupyter-clickhouse/><link rel=stylesheet href=https://www.wangfenjin.com/assets/style.css><link rel=stylesheet href=https://www.wangfenjin.com/assets/green.css><link rel=stylesheet href=https://www.wangfenjin.com/style.css><link rel=apple-touch-icon href=https://www.wangfenjin.com/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://www.wangfenjin.com/favicon.ico><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="xeus-clickhouse: Jupyter 的 ClickHouse 内核"><meta property="og:description" content="支持直接在 jupyter 中用 clickhouse sql 查询数据"><meta property="og:url" content="https://www.wangfenjin.com/posts/jupyter-clickhouse/"><meta property="og:site_name" content="Wang Fenjin"><meta property="og:image" content="https://www.wangfenjin.com/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-06-28 00:00:00 +0000 UTC"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Wang Fenjin's Blog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>Home</a></li><li><a href=/about>About</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://www.wangfenjin.com/posts/jupyter-clickhouse/>xeus-clickhouse: Jupyter 的 ClickHouse 内核</a></h1><div class=post-meta><span class=post-date>2020-06-28</span>
<span class=post-author>:: Wang Fenjin</span></div><span class=post-tags>#<a href=https://www.wangfenjin.com/tags/clickhouse/>clickhouse</a>&nbsp;
#<a href=https://www.wangfenjin.com/tags/jupyter/>jupyter</a>&nbsp;
#<a href=https://www.wangfenjin.com/tags/jupyter-kernal/>jupyter-kernal</a>&nbsp;</span><div class=post-content><div><p>在科学计算领域，Jupyter 是一个使用非常广泛的集成开发环境，它支持多种主流的编程语言比如 Python, C++, R 或者 Julia。同时，数据科学最重要的还是数据，而 SQL 是操作数据最直观的语言。前段时间看到<a href=https://blog.jupyter.org/a-jupyter-kernel-for-sqlite-9549c5dcf551>一篇文章</a>，有人给 sqlite 做了一个 jupyter 的内核，感觉很有意思。所以我尝试给 ClickHouse 做了一个 jupyter 的内核，目前已经有了一个可以试用的版本，下面做一个简单介绍。</p><h2 id=现状>现状<a href=#现状 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>新内核允许用户用 ClickHouse SQL 的语法直接操作远程 CH 数据库，通过一些扩展操作比如 <code>%CONNECT</code> 支持与 ch cli 一样的连接参数，后续也有计划使用 jupyter magics 支持更多的数据可视化操作。</p><p>项目参考了 jupyter sqlite 内核的实现方式，是基于 <a href=https://github.com/jupyter-xeus/xeus>xeus</a> 框架来实现的。xeus 是一个 c++ 的 lib 库，它对 jupyter 的内核做了很好的封装，我们只需要专注于内核相关的功能就可以了。目前对于 ch 的操作基于 clickhouse-cpp 来实现，它是 ch 的 cpp 客户端。</p><p><img src=/img/ch-sql.gif alt=ch-sql></p><p>目前实现处于早期阶段，但是基础功能已经可用。它支持了几乎 CH 所有 SQL 语法，具体例子可以参考 <a href=https://github.com/wangfenjin/xeus-clickhouse/blob/master/examples/clickhouse.ipynb>clickhouse.ipynb</a>。xeus-clickhouse 在 jupyter notebook 和 jupyter lab 中以 HTML 表格的形式展示数据；在 jupyter console 中，我们使用 tabulate 库只做纯文本的表格。</p><h2 id=未来>未来<a href=#未来 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>对于 xeus-clickhouse 未来的规划是，先打磨好稳定性，目前已知的还有一个非法字符导致内核崩溃的问题，已经提交 issue 给 xeus 仓库；另外clickhouse-cpp 不支持 ssl 连接。除了基础功能的打磨，还计划通过支持更多的 jupyter magic 来实现数据的可视化渲染，提供更方便的数据可视化能力。</p><h2 id=使用>使用<a href=#使用 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>我制作了一个 Docker 镜像发布在 <a href=https://hub.docker.com/r/wangfenjin/xeus-clickhouse>docker-hub</a>，不需要安装任何环境就可以试用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># start jupyter with clickhouse kernal</span>
</span></span><span style=display:flex><span>docker run -p 8888:8888 wangfenjin/xeus-clickhouse:v0.1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># start a local clickhouse for testing</span>
</span></span><span style=display:flex><span>docker run -d --name jupyter-clickhouse-server -p 8123:8123 --ulimit nofile<span style=color:#f92672>=</span>262144:262144 yandex/clickhouse-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># open the example/clickhouse.ipynb and connect to local server by </span>
</span></span><span style=display:flex><span><span style=color:#75715e># %CONNECT --host host.docker.internal --port 8123</span>
</span></span></code></pre></div><p>在 docker 里面连接另外一个 docker 中的 ch 可能会有问题，感觉是目前 clickhouse-cpp 对于网络的处理不太完善。感兴趣的同学也可以下载代码自己编译，具体的编译流程见 <a href=https://github.com/wangfenjin/xeus-clickhouse>github</a> 仓库。欢迎大家试用！</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://www.wangfenjin.com/posts/simple-jieba-tokenizer/><span class=button__icon>←</span>
<span class=button__text>Simple: SQLite3 结巴分词插件</span></a></span>
<span class="button next"><a href=https://www.wangfenjin.com/posts/clickhouse-od/><span class=button__text>用 od 查看 ClickHouse 的索引文件</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=wangfenjin/wangfenjin.github.io issue-term=pathname label=utteranc.es theme=github-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Copyright © 2022 Wang Fenjin :: Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://www.wangfenjin.com/assets/main.js></script>
<script src=https://www.wangfenjin.com/assets/prism.js></script></div></body></html>